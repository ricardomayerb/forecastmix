---
title: 'Multiple models: a two-models speedy case'
author: "Ricardo Mayer"
date: "12/6/2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r source-and-lib, message=FALSE, warning=FALSE}
source('./R/combinations_functions.R')
```


## VAR-ready data set
    
We will use the example dataset with domestic series from Uruguay and few external series. The rds file contains the country's name, the transformation applied to rgdp to render it stationary and two data sets: the original or raw data and one ready to used in VAR estimation,  containing only stationary versions of the original series. 


```{r loading_data}
data_object_ury <- readRDS("./data/examples/example_data_ury.rds")
print(names(data_object_ury))
country <- data_object_ury$country_name
target_transformation <- data_object_ury$target_transformation
raw_data <- data_object_ury$raw_data
var_data <- data_object_ury$transformed_data
print(target_transformation)

names_exogenous <- c("ip_us","ip_asia","ip_ue","ip_bra","act_eco_bra","emae_arg")

extension_of_exo <- readRDS(file = "./data/examples/example_extension_of_exo.rds")
cv_extension_of_exo <- readRDS(file = "./data/examples/example_cv_extension_of_exo.rds")

```



## Getting a tibble with multiple specifications

```{r subsetsofspecifications}
var_size <- 3 
all_variables <- colnames(var_data)
target_variable <- "rgdp"
non_target_fixed <- c("")

tic()
specifications_size_3_all <- all_specifications(
  var_size = 3, all_variables = colnames(var_data),
  lag_choices = c(3,4,5), use_info_lags = TRUE,
  var_data = var_data, t_thresholds = c(1.65, 2), names_exogenous = names_exogenous)
toc()

specifications_size_3_17 <- specifications_size_3_all[1:17, ] 


```


## Fit all specifications and keep only acceptable ones

```{r  passing_models_size3small, cache=TRUE}
ftmt_size_3_17 <- fit_tests_models_table(specifications_size_3_17, var_data = var_data, names_exogenous = names_exogenous)
pm_size_3_17 <- ftmt_size_3_17[["passing_models"]]
print(head(pm_size_3_17))
pm_3specs <- pm_size_3_17[c(1, 11, 21), ]


```


## Add forecast performance information via Time Series Cross Validation 


```{r tscv}
n_cv <- 10
fc_horizon <- 8
training_length <- "per_cv_maxs" 
fit_column <- "fit"
target_transform <- target_transformation
target_level_ts <- na.omit(raw_data[, target_variable])


tic()
cv_size_3_17 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = pm_size_3_17, 
                             var_data = var_data, 
                             fit_column = NULL, 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts, 
                             names_exogenous = names_exogenous, 
                             future_exo = extension_of_exo, 
                             extended_exo_mts = cv_extension_of_exo,
                             keep_varest_obj = FALSE
                             )
toc()

# 
# tic()
# cv_size_3_17_use_previous_fit <- cv_var_from_model_tbl(h = fc_horizon,
#                                                training_length = training_length, 
#                                                n_cv = n_cv,
#                                                models_tbl = pm_size_3_17, 
#                                                var_data = var_data, 
#                                                fit_column = "fit", 
#                                                target_transform = target_transform,
#                                                target_level_ts = target_level_ts, 
#                                                names_exogenous = names_exogenous, 
#                                                future_exo = extension_of_exo, 
#                                                extended_exo_mts = cv_extension_of_exo,
#                                                keep_varest_obj = FALSE
# )
# toc()


```

## Combine individual-models forecasts into a weigthed average forecast

### First step: forecasts from individual models

```{r full_sample_fc}

fcs_from_all <- forecast_var_from_model_tbl(
  models_tbl = cv_size_3_17,
  var_data = var_data, 
  fc_horizon = fc_horizon, 
  target_transform = target_transform,
  target_level_ts = target_level_ts,
  names_exogenous = names_exogenous, 
  extended_exo_mts = extension_of_exo, 
  keep_wide_tbl = TRUE
)

long_tbl <- fcs_from_all$models_tbl
wide_tbl <-  fcs_from_all$models_tbl_wide
info_per_h <- fcs_from_all$models_info_per_h

```

### Second step: do a weighted average of forecasts' means

```{r ensemble_mean}
# h_max <- fc_horizon
ensemble_fc_list <- fc_mean_of_VAR_ensemble(models_tbl = fcs_from_all$models_tbl)
ensemble_fc_tbl <- ensemble_fc_list$ensemble_tbl
ensemble_fc_ts <- ensemble_fc_list$weighted_avg_fc_yoy

```

### Third step: TSCV of weighted average, compute RMSE and put all together

```{r tscv_of_ensemble}
ensemble_cv <- cv_of_VAR_ensemble(var_data = var_data,
                                  used_cv_models = fcs_from_all$models_tbl_wide,
                                  fc_horizon = fc_horizon,
                                  n_cv = n_cv,
                                  training_length = training_length,
                                  cv_extension_of_exo = cv_extension_of_exo,
                                  names_exogenous = names_exogenous,
                                  max_rank_h = NULL,
                                  target_transform = target_transform,
                                  target_level_ts = target_level_ts)

```

and bind them

```{r bind_indiv_ensemble}

ensemble_fc_and_rmse <- ensemble_fc_tbl %>% 
  mutate(rmse_h = paste0("rmse_", 1:n()),
         rmse = ensemble_cv$ensemble_rmse,
         rank = -1)

fcs_models_to_bind <- fcs_from_all$models_tbl %>% 
  mutate(lags = list(lags)) %>% 
  dplyr::select(names(ensemble_fc_and_rmse))


models_and_ensemble_fcs <- rbind(ensemble_fc_and_rmse, 
                                 fcs_models_to_bind)

```


### Three steps in one function

```{r threestepsinone}

final_tbl <- ensemble_fc_from_models_rmse(models_tbl_with_rmse = cv_size_3_17,
                             var_data = var_data, 
                             n_cv = n_cv, 
                             training_length = training_length, 
                             max_rank_h = NULL, 
                             fc_horizon = fc_horizon,
                             names_exogenous = names_exogenous, 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             extension_of_exo = extension_of_exo, 
                             cv_extension_of_exo = cv_extension_of_exo, 
                             fit_column = NULL)
```



## Change the number of models based on model rankings


```{r fcs_max_10}

foo_long <- discard_by_rank(fcs_from_all$models_tbl, max_rank_h = 3, is_wide = FALSE)

foo_wide <- discard_by_rank(fcs_from_all$models_tbl_wide, max_rank_h = 3, is_wide = TRUE)

sort(unique(foo_long$short_name))
sort(unique(foo_wide$short_name))
identical(sort(unique(foo_long$short_name)), sort(unique(foo_wide$short_name)))



fcs_from_all_e_10 <- forecast_var_from_model_tbl(
  models_tbl = cv_size_3_17_estimate,
  var_data, 
  fc_horizon, 
  target_transform = target_transform,
  target_level_ts = target_level_ts,
  names_exogenous = names_exogenous, 
  extended_exo_mts = extension_of_exo, 
  keep_wide_tbl = TRUE,
  max_rank_h = 10
)



final_tbl_10 <- ensemble_fc_from_models_rmse(models_tbl_with_rmse = cv_size_3_17,
                             var_data = var_data, 
                             n_cv = n_cv, 
                             training_length = training_length, 
                             max_rank_h = 10, 
                             fc_horizon = fc_horizon,
                             names_exogenous = names_exogenous, 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             extension_of_exo = extension_of_exo, 
                             cv_extension_of_exo = cv_extension_of_exo, 
                             fit_column = NULL)


```






The function forecast_var_from_model_tbl by default, it just take all specifications in given tibble and produce forecasts of the target variable, more precisely it creates a list-column containing mean forecasts of YoY growth of the target variable over the specified forecast horizon. Some options include to keep varest or forecast objects (not advised with very long tibbles) and more importantly it can restrict the sample of models by keeping only the best  models at each horizon and computing a (rmse-)weighted average mean forecast.

In this case we take our models from the cv-exercises, thus all models where already tested for stability, restrictions and white noise residuals and therefore we can spare those test here, which is the default behaviour.


this_fc_tbl

