---
title: 'Multiple models: a two-models speedy case'
author: "Ricardo Mayer"
date: "12/6/2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r source-and-lib, message=FALSE, warning=FALSE}
source('./R/combinations_functions.R')
```

We will start with a ready to use data set with quarterly, stationary series than can be used in an ordinary VAR, and we will not explain how the data munging is done. In particular, we will *not* discuss the following important points:
    - how the data was obtained
    - how monthly data was converted to quaterly frequency
    - how monthly data was *extended* to complete its current final quarter
    - how (potentially) exogenous data was forecasted in order to make it available to produce conditional forecasts
    - how each series was transformed using seasonal and oridinary differeces to render them stationary
    
All those points are discussed in the data preparation document, see *here*

## VAR-ready data set
    
We will use the example dataset with domestic series from Uruguay and few external series. The rds file contains the country's name, the transformation applied to rgdp to render it stationary and two data sets: the original or raw data and one ready to used in VAR estimation,  containing only stationary versions of the original series. 


```{r loading_data}
data_object_ury <- readRDS("./data/examples/example_data_ury.rds")
print(names(data_object_ury))
country <- data_object_ury$country_name
target_transformation <- data_object_ury$target_transformation
raw_data <- data_object_ury$raw_data
var_data <- data_object_ury$transformed_data
print(target_transformation)
```

In this case, all VARs will use a  "diff-yoy" transformation of the real GDP series (i.e. first, take seasonal differences on the quarterly series and then ordinary differences on the result).    


## Counting specifications

The total number of potential specifications depends on a number of factors:
 - number of variable combinations. Which in turn depends on:
    - the total number of variables in the data set
    - the number of variables in the VAR (the "size" of the VAR: 2, 3, 4 ...)
    - the number of exogenous variables in the data set. This is because we generally choose leave out VARs where there is only one endogenous variable and all the rest are exogenous. That's more properly called an ARIMAX model. The default is to ignore such models when they show up, but it can be changed.
 - number of maximum lags to consider: e.g. 3, 4, 5 and 6
 - number of restricted version to consider: unrestricted, t = 1.65 and t = 2
 
 With two restricted version, plus the unrestricted one and four possible lag choices, we generate 12 specification per each variable combination we submit. A more modest inquiry may examine only unrestricted models for two lag choices, in which case ge only generate 2 specifications per tuple of variables. Say we have 500 combinations of variables to try out, that would tipically imply between 2x500 = 1000 and 12x500 = 6000 specifications to estimate, test and do cross-validation. 
 
A formula of the number of combinations, ignoring the distinction between endogenous and exogenpus variables, can be written as:

$$ncomb = \frac{(n - n_f)!}{(n - n_f - s - n_f)! ~ (s-n_f)!} = \frac{(n_a)!}{(n_a - s_a)! ~ (s_a)!}$$

Where $n$ is the total number of variables in the data set, $s$ is the number of distinct variables in the VAR (the "size") and $n_f$ is the number of *fixed variables*, i.e. those that need to be in any VAR (tipically $rgdp$ in our examples but it is *always* an endogenous variable and since we have at least one target variable it is at least equal to one). It can be more succintly expressed in the number of adjusted (for combinatorial purposes) numbers of variables to choose from,  $n_a := n -n_f$, and the adjusted  numbers of slots to fill, $s_a := s - n_f$. 

If we wanted to exclude those VAR with just one endogenous variables, then we can adjust $ncomb$ above by this quantity (notice that this case can only happen when we have only one endogenous variable acting as fixed variable):

$$ncomb_x = \frac{n_x!}{(n_x - (s-1))! ~ (s-1)!}$$
Where $n_x$ is the number of variables that we consider as exogenous. Notice that this number is zero in whenever there is less objects to choose from than the number of slots to be fill i.e when $n_x < s-1$.

Finally, we could define

$$ncomb^* = ncomb - ncomb_x$$

as the number of combinations, adjusted by ignoring VARs with only one endogenous variables. The table below shows, however that for the case of Uruguay (and it will be the case for the rest of our countries) it makes very little difference in the final number of variable combinations.
 

```{r countingcombinations}


ncombs <- map(2:7, ~ count_combn(var_size = .x, n_total = 31, n_exo = 6, n_fixed = 1))
ntable <- as_tibble(cbind(n = ncol(var_data), n_fixed = 1, size = 2:7, reduce(ncombs, rbind)))
print(ntable)

# ncombs41 <- map(2:7, ~ count_combn(var_size = .x, n_total = 41, n_exo = 6, n_fixed = 1))
# ntable41 <- as_tibble(cbind(n = ncol(var_data), n_fixed = 1, size = 2:7, reduce(ncombs41, rbind)))
# print(ntable41)
# 
# ncombs10 <- map(2:7, ~ count_combn(var_size = .x, n_total = 10, n_exo = 6, n_fixed = 1))
# ntable10 <- as_tibble(cbind(n = ncol(var_data), n_fixed = 1, size = 2:7, reduce(ncombs10, rbind)))
# print(ntable10)
```

 
Notice how rapidly the number of combinations increases with VAR size. Since $comb_x$ is relatively small here, for the next table we will consider $ncomb$ alone. Depending on the number of different lags and restrictions the final number of specification will tipically  be from two (no restrictions and two lag choices) to twelve times (two restrictions and four lag choices) the number of variable combinations. In the following table we consider the resulting number of specification under those two scenarios plus the number of estimations made taking into account ten rounds of cross validations in addition to the full sample original estimate. Since at least some models will fail the tests, only a fraction of them will qualify to be passed to cross-validation. The table below assume that between 20 to 90 percent of the models will pass. So the minimum number of VAR estimation to do happens in the no-restriction, two lag choices and 20% of qulifiying, whereas the maximum number of estimation would happens if 90% of the models pass the test and we are trying four lag choices and two restrictions.


```{r nspecifications}

nspectable <- ntable %>% dplyr::select(size, ncomb)

nspectable <- nspectable %>% 
  mutate(nVAR_2 = ncomb*2, nVAR_12 = ncomb*12, cv_min = nVAR_2*0.2*10, cv_max = nVAR_12*0.9*10)

print(nspectable)


```

Even with a modest size of 4, we can be dealing with 50,000 specification (and tests) and almost half a million estimations. Projecting how long those estimatiation would take, needs to consider that restricted estimations are slower than unrestrited ones and we will leave that for later. By this time we just want to notice that in order to use VAR of size 5 we either confine ourselves to unrestricted models and few lag choices or we need to find a strategy to select variables that lowers the number of possible combinations to be explored.

To expede wthing up in this document we will restrict oour attention to size-3 VARs, usig at first two variable combinations and at the end using all of them.



## Generate all specifications for a given size



```{r tuplesofvbls}

var_size <- 3 
all_variables <- colnames(var_data)
target_variable <- "rgdp"
non_target_fixed <- c("")


# 1742
tic()
specifications_size_3_all_u <- all_specifications(
  var_size = 3, all_variables = colnames(var_data),
  lag_choices = c(3,4,5), use_info_lags = TRUE,
  var_data = var_data, t_thresholds = 0)
toc()

# 1742
tic()
specifications_size_3_all_u_noinfolags <- all_specifications(
  var_size = 3, all_variables = colnames(var_data),
  lag_choices = c(3,4,5), use_info_lags = FALSE,
  var_data = var_data, t_thresholds = 0)
toc()

# 1742
tic()
specifications_size_3_all <- all_specifications(
  var_size = 3, all_variables = colnames(var_data),
  lag_choices = c(3,4,5), use_info_lags = TRUE,
  var_data = var_data, t_thresholds = c(1.65, 2))
toc()



# 1305
tic()
specifications_size_3_all_noinfolag <- all_specifications(
  var_size = 3, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65, 2))
toc()



```

### Select a subset of specification for expediency in this document
```{r s3smmd}

specifications_size_3_17 <- specifications_size_3_all[1:17, ] 
specifications_size_3_170 <- specifications_size_3_all[1:170, ] 

specifications_size_3_17_u <- specifications_size_3_all_u[1:17, ] 
specifications_size_3_170_u <- specifications_size_3_all_u[1:170, ] 

```


## Fit all specifications and keep only acceptable ones

```{r  passing_models_size3small}
ftmt_size_3_17 <- fit_tests_models_table(specifications_size_3_17, var_data = var_data)
pm_size_3_17 <- ftmt_size_3_17[["passing_models"]]
print(head(pm_size_3_17))

ftmt_size_3_17_u <- fit_tests_models_table(specifications_size_3_17_u, var_data = var_data)
pm_size_3_17_u <- ftmt_size_3_17_u[["passing_models"]]
print(head(pm_size_3_17_u))

# ftmt_size_3_170_u <- fit_tests_models_table(specifications_size_3_170_u, var_data = var_data)
# pm_size_3_170_u <- ftmt_size_3_170_u[["passing_models"]]
# 
# ftmt_size_3_170 <- fit_tests_models_table(specifications_size_3_170, var_data = var_data)
# pm_size_3_170 <- ftmt_size_3_170[["passing_models"]]

# ftmt_size_3_big <- fit_tests_models_table(specifications_size_3_big, var_data = var_data)
# pm_size_3_big <- ftmt_size_3_big[["passing_models"]]

```


## Time Series Cross Validation on valid specifications

```{r tscv_s3small}
fc_horizon <- 8
n_cv <- 10
# training_length <- 30
training_length <- "per_cv_maxs" 
fit_column <- "fit"
target_transform <- target_transformation
target_level_ts <- na.omit(raw_data[, target_variable])

tic()
cv_size_3_17 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = pm_size_3_17, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
toc()

# tic()
# cv_size_3_170 <- cv_var_from_model_tbl(h = fc_horizon,
#                              training_length = training_length, 
#                              n_cv = n_cv,
#                              models_tbl = pm_size_3_170, 
#                              var_data = var_data, 
#                              fit_column = "fit", 
#                              target_transform = target_transform,
#                              target_level_ts = target_level_ts,
#                              )
# toc() 

```



## Combine forecasts based on performance measure


```{r forecast_using_cv}

# rank and filter

max_rank_h <- 5

surviving_names <- cv_size_3_17 %>% 
  gather(key = "rmse_h", value = "rmse", 
         vars_select(names(.), starts_with("rmse"))) %>% 
  group_by(rmse_h) %>% 
  mutate(rank_h = rank(rmse)) %>% 
  filter(rank_h <= max_rank_h) %>% 
  ungroup() %>% 
  dplyr::select(short_name) %>% 
  distinct()

rank_filtered_models <- semi_join(cv_size_3_17, surviving_names, by = "short_name")

# use all models
fc_s3_17 <- forecast_var_from_model_tbl(
  rank_filtered_models, var_data, fc_horizon, 
  target_transform = target_transform,
  target_level_ts = target_level_ts, do_tests = FALSE, 
  both_rest_unrest = TRUE) 

do_rmse_average <- TRUE

if (do_rmse_average) {
  fcs_and_weights <- fc_s3_17 %>% 
  gather(key = rmse_h, value = rmse, vars_select(names(.), starts_with("rmse"))) %>% 
  group_by(rmse_h) %>% 
  mutate(rank_h = rank(rmse)) %>% 
  filter(rank_h <= max_rank_h) %>% 
  mutate(inv_mse = 1/(rmse*rmse),
         model_weight = inv_mse/sum(inv_mse),
         horizon = as.numeric(substr(rmse_h, 6, 6)),
         this_h_fc_yoy = map2_dbl(target_mean_fc_yoy, horizon, ~ .x[.y]),
         weighted_this_h_fc_yoy = map2_dbl(this_h_fc_yoy, model_weight, ~ .x*.y),
         waverage_fc_yoy_h = sum(weighted_this_h_fc_yoy)
         ) 

  fc_yoy_w_ave <- ts(unique(fcs_and_weights$waverage_fc_yoy_h), 
                     start = start(fcs_and_weights$target_mean_fc_yoy[[1]]),
                     frequency = frequency(fcs_and_weights$target_mean_fc_yoy[[1]]))
  
  fcs_and_wavg <- list(tbl_models_and_fcs = fcs_and_weights,
                       fcs_wavg = fc_yoy_w_ave)
}

moo <-  forecast_var_from_model_tbl(
  rank_filtered_models, var_data, fc_horizon, 
  target_transform = target_transform,
  target_level_ts = target_level_ts, do_tests = FALSE,
  both_rest_unrest = TRUE, do_rmse_average = TRUE, max_rank_h = 5) 

fc_s3_small_wavg <- moo$fcs_wavg

moo <-  forecast_var_from_model_tbl(
  rank_filtered_models, var_data, fc_horizon, 
  target_transform = target_transform,
  target_level_ts = target_level_ts, do_tests = FALSE,
  both_rest_unrest = TRUE, do_rmse_average = TRUE, max_rank_h = 5, 
  filter_by_rank = TRUE) 

```


## Computing time and object size


### Specifications to test

For most of the comparison we will fix the the number of specifications at 100. Restricted estimation complicated this accounting a bit: with one threshold (e.g 1.65) it adds one unrestricted estimation per each restricted model, so it is effectively working with two specifications, adn with two thresholds (e.g. c(1.65, 2)) it estimated the unrestried model once and uses it for both restricted models, thus is closer to working with three specifications, not two or four. On top of that, restricted estimation are more expensive than unrestricted ones, thus computing times are not simply twice or thrice the computing time of the corresponding unrestricted models, and so it is a good idea time them explicitely.

Subseting of specifications are made by a random sample of the rows of all specifications. A more accurate estimate could be obtaining by taking several of this samples and average their resulting computing times. We expect some variation bc a given sample could result in larger or smaller fraction of models passing the tests and therefore selected for cross-validation, as we will see.


 
```{r spec_for_timings}

# unrestricted, all var_sizes
specs_s3_all_u_noinfolags <- all_specifications(
  var_size = 3, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)

specs_s4_all_u_noinfolags <- all_specifications(
  var_size = 4, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)

specs_s5_all_u_noinfolags <- all_specifications(
  var_size = 5, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)

specs_s3_100_u_nil <- sample_n(specs_s3_all_u_noinfolags, 100)  
specs_s4_100_u_nil <- sample_n(specs_s4_all_u_noinfolags, 100)  
specs_s5_100_u_nil <- sample_n(specs_s5_all_u_noinfolags, 100)  


# restricted 1.65, all var_sizes
specs_s3_all_165_noinfolags <- all_specifications(
  var_size = 3, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65), silent = TRUE)

specs_s4_all_165_noinfolags <- all_specifications(
  var_size = 4, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65), silent = TRUE)

specs_s5_all_165_noinfolags <- all_specifications(
  var_size = 5, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65), silent = TRUE)

specs_s3_100_165_nil <- sample_n(specs_s3_all_165_noinfolags, 100) 
specs_s4_100_165_nil <- sample_n(specs_s4_all_165_noinfolags, 100)  
specs_s5_100_165_nil <- sample_n(specs_s5_all_165_noinfolags, 100)  


# restricted 1.65 and 2, all var_sizes
specs_s3_all_165_2_noinfolags <- all_specifications(
  var_size = 3, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65, 2), silent = TRUE)

specs_s4_all_165_2_noinfolags <- all_specifications(
  var_size = 4, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65, 2), silent = TRUE)

specs_s5_all_165_2_noinfolags <- all_specifications(
  var_size = 5, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = c(1.65, 2), silent = TRUE)

specs_s3_100_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 100) 
specs_s4_100_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 100)  
specs_s5_100_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 100)  


print(nrow(specs_s3_all_u_noinfolags))
print(nrow(specs_s4_all_u_noinfolags))
print(nrow(specs_s5_all_u_noinfolags))
print(nrow(specs_s4_all_u_noinfolags)/nrow(specs_s3_all_u_noinfolags))
print(nrow(specs_s5_all_u_noinfolags)/nrow(specs_s3_all_u_noinfolags))


```



### Timing searches of unrestricted and restricted models
```{r timing_functions, message=FALSE, warning=FALSE, include=FALSE}

time_fit_cv <- function(var_data, target_level_ts, reps = 1, 
                        var_sizes = c(3,4,5), tosample = 100, lags = c(3,4,5),
                        use_info_lags = FALSE, t_thresholds = 0,
                        training_length = "per_cv_maxs",
                        n_cv = 10, target_transform = "diff_yoy",
                        fc_horizon = 8) {
  
  all_reps_timings <- list_along(seq(1, reps))
  all_reps_counts <- list_along(seq(1, reps))
  mean_timing <- 0
  
  for (r in seq(1, reps)) {
    all_et_fit <- vector(mode = "numeric", length = length(var_sizes)) 
    all_et_cv <- vector(mode = "numeric", length = length(var_sizes)) 
    all_n_fit <- vector(mode = "numeric", length = length(var_sizes)) 
    all_n_cv <- vector(mode = "numeric", length = length(var_sizes)) 
    all_n_lost_to_roots <- vector(mode = "numeric", length = length(var_sizes)) 
    all_n_lost_to_white <- vector(mode = "numeric", length = length(var_sizes)) 
    all_n_lost_to_threshold <- vector(mode = "numeric", length = length(var_sizes)) 
    for (i in seq(length(var_sizes))) {
      print(paste0("Starting var_size = ", var_sizes[i], 
                   " (", i, " of ", length(var_sizes),")"))
      
      specs <- all_specifications(var_size = var_sizes[i], 
                                  all_variables = colnames(var_data),
                                  lag_choices = lags,
                                  use_info_lags = use_info_lags,
                                  var_data = var_data, 
                                  t_thresholds = t_thresholds,
                                  silent = TRUE)
      
      specs_sample <- sample_n(specs, tosample)
      
      tic()
      fit_list <- fit_tests_models_table(specs_sample, var_data = var_data)
      fit_toc <- toc()
      et_fit <- (fit_toc$toc - fit_toc$tic) 
      all_et_fit[i] <- et_fit
      
      all_n_fit[i] <- tosample
      all_n_cv[i] <- nrow(fit_list$passing_models)
      all_n_lost_to_roots[i] <- fit_list$n_lost_to_roots
      all_n_lost_to_white[i] <- fit_list$n_lost_to_white
      all_n_lost_to_threshold[i] <- fit_list$n_lost_to_threshold
      
      tic()
      cv_tbl <- cv_var_from_model_tbl(h = fc_horizon,
                                      training_length = training_length, 
                                      n_cv = n_cv,
                                      models_tbl = fit_list$passing_models, 
                                      var_data = var_data, 
                                      fit_column = "fit", 
                                      target_transform = target_transform,
                                      target_level_ts = target_level_ts
      )
      cv_toc <- toc()
      et_cv <- (cv_toc$toc - cv_toc$tic) 
      all_et_cv[i] <- et_cv
    }
    
    all_et_fit_cv <- all_et_cv + all_et_fit 
    
    # print(all_et_fit)
    # print(all_et_fit/all_et_fit[1])
    # 
    # print(all_et_cv)
    # print(all_et_cv/all_et_cv[1])
    # 
    # print(all_et_fit_cv)
    # print(all_et_fit_cv/all_et_fit_cv[1])
    
    all_timings <- rbind(all_et_fit, all_et_fit/all_et_fit[1],
                         all_et_cv, all_et_cv/all_et_cv[1],
                         all_et_fit_cv, all_et_fit_cv/all_et_fit_cv[1])
    
    mean_timing <- mean_timing + all_timings
    
    all_counts <- rbind(all_n_fit, all_n_lost_to_threshold, all_n_lost_to_roots,
                        all_n_lost_to_white, all_n_cv)
    
    all_reps_timings[[r]] <- all_timings
    all_reps_counts[[r]] <- all_counts
  }
  
  mean_timing <- mean_timing/reps
  
  return(list(ave_timing = mean_timing,
              timings = all_reps_timings, 
              counts = all_reps_counts))
}



this_target_ts <- na.omit(raw_data[,target_variable])
tic()
t_100_u <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts, 
                       reps = 3)
toc()

tic()
t_100_r165 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                          reps = 3, t_thresholds = 1.65)
toc()


tic()
t_100_r165_r2 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                          reps = 3, t_thresholds = c(1.65, 2)) 
toc()
```

examining timings and counts

```{r averagetimings}
print(t_100_u$ave_timing)
print(t_100_r165$ave_timing)
print(t_100_r165_r2$ave_timing)

specs_s3_all_u_noinfolags <- all_specifications(
  var_size = 3, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)

specs_s4_all_u_noinfolags <- all_specifications(
  var_size = 4, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)

specs_s5_all_u_noinfolags <- all_specifications(
  var_size = 5, all_variables = colnames(var_data), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = var_data, t_thresholds = 0, silent = TRUE)


print(nrow(specs_s3_all_u_noinfolags))
print(nrow(specs_s4_all_u_noinfolags))
print(nrow(specs_s5_all_u_noinfolags))

all_specs_timings_u <- t_100_u$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags), nrow(specs_s4_all_u_noinfolags), nrow(specs_s5_all_u_noinfolags))/100
sum_all_specs_timings_u <- sum(all_specs_timings_u)
sum_all_specs_timings_u
sum_all_specs_timings_u/60
sum_all_specs_timings_u/3600

all_specs_timings_165 <- t_100_r165$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags), nrow(specs_s4_all_u_noinfolags), nrow(specs_s5_all_u_noinfolags))/100
sum_all_specs_timings_165 <- sum(all_specs_timings_165)
sum_all_specs_timings_165
sum_all_specs_timings_165/60
sum_all_specs_timings_165/3600

all_specs_timings_165_2 <- t_100_r165_r2$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags), nrow(specs_s4_all_u_noinfolags), nrow(specs_s5_all_u_noinfolags))/100
sum_all_specs_timings_165_2 <- sum(all_specs_timings_165_2)
sum_all_specs_timings_165_2
sum_all_specs_timings_165_2/60
sum_all_specs_timings_165_2/3600



sum_all_specs_timings_u/3600
sum_all_specs_timings_165/3600
sum_all_specs_timings_165_2/3600
```


### Try smaller data set (15 variables)

```{r smaller_uruguay}

ury_no_rgdp <- var_data[, !colnames(var_data) == "rgdp"]
ury_14 <- ury_no_rgdp[, 1:14]
ury_15 <- cbind(var_data[, "rgdp"], ury_14)  
colnames(ury_15) <- c("rgdp", colnames(ury_14))

```

now time it

```{r timing_ury_15}

# tic()
# t_100_u_ury15 <- time_fit_cv(var_data = ury_15, target_level_ts = this_target_ts, 
#                        reps = 3)
# toc()
# 
# tic()
# t_100_r165_ury15 <- time_fit_cv(var_data = ury_15, target_level_ts = this_target_ts,
#                           reps = 3, t_thresholds = 1.65)
# toc()
# 
# 
# tic()
# t_100_r165_r2_ury15 <- time_fit_cv(var_data = ury_15, target_level_ts = this_target_ts,
#                           reps = 3, t_thresholds = c(1.65, 2)) 
# toc()

# 
# print(t_100_u_ury15$ave_timing)
# print(t_100_r165_ury15$ave_timing)
# print(t_100_r165_r2_ury15$ave_timing)

specs_s3_all_u_noinfolags_ury_15 <- all_specifications(
  var_size = 3, all_variables = colnames(ury_15), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)

specs_s4_all_u_noinfolags_ury_15 <- all_specifications(
  var_size = 4, all_variables = colnames(ury_15), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)

specs_s5_all_u_noinfolags_ury_15 <- all_specifications(
  var_size = 5, all_variables = colnames(ury_15), 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)


print(nrow(specs_s3_all_u_noinfolags_ury_15))
print(nrow(specs_s4_all_u_noinfolags_ury_15))
print(nrow(specs_s5_all_u_noinfolags_ury_15))


all_specs_timings_u_15 <- t_100_u$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_ury_15), nrow(specs_s4_all_u_noinfolags_ury_15), nrow(specs_s5_all_u_noinfolags_ury_15))/100
sum_all_specs_timings_u_15 <- sum(all_specs_timings_u_15)
sum_all_specs_timings_u_15
sum_all_specs_timings_u_15/60
sum_all_specs_timings_u_15/3600

all_specs_timings_165_15 <- t_100_r165$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_ury_15), nrow(specs_s4_all_u_noinfolags_ury_15), nrow(specs_s5_all_u_noinfolags_ury_15))/100
sum_all_specs_timings_165_15 <- sum(all_specs_timings_165_15)
sum_all_specs_timings_165_15
sum_all_specs_timings_165_15/60
sum_all_specs_timings_165_15/3600

all_specs_timings_165_2_15 <- t_100_r165_r2$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_ury_15), nrow(specs_s4_all_u_noinfolags_ury_15), nrow(specs_s5_all_u_noinfolags_ury_15))/100
sum_all_specs_timings_165_2_15 <- sum(all_specs_timings_165_2_15)
sum_all_specs_timings_165_2_15
sum_all_specs_timings_165_2_15/60
sum_all_specs_timings_165_2_15/3600


```

and with 41 variables


```{r timing_ury_15}


names41 <- c(colnames(var_data), letters[1:10]) 

specs_s3_all_u_noinfolags_fake_41 <- all_specifications(
  var_size = 3, all_variables = names41, 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)

specs_s4_all_u_noinfolags_fake_41 <- all_specifications(
  var_size = 4, all_variables =  names41, 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)

specs_s5_all_u_noinfolags_fake_41 <- all_specifications(
  var_size = 5, all_variables =  names41, 
  lag_choices = c(3,4,5), use_info_lags = FALSE, 
  var_data = ury_15, t_thresholds = 0, silent = TRUE)


print(nrow(specs_s3_all_u_noinfolags_fake_41))
print(nrow(specs_s4_all_u_noinfolags_fake_41))
print(nrow(specs_s5_all_u_noinfolags_fake_41))


all_specs_timings_fake_41 <- t_100_u$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_fake_41), nrow(specs_s4_all_u_noinfolags_fake_41), nrow(specs_s5_all_u_noinfolags_fake_41))/100
sum_all_specs_timings_fake_41 <- sum(all_specs_timings_fake_41)
sum_all_specs_timings_fake_41
sum_all_specs_timings_fake_41/60
sum_all_specs_timings_fake_41/3600

all_specs_timings_165_fake_41 <- t_100_r165$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_fake_41), nrow(specs_s4_all_u_noinfolags_fake_41), nrow(specs_s5_all_u_noinfolags_fake_41))/100
sum_all_specs_timings_165_fake_41 <- sum(all_specs_timings_165_fake_41)
sum_all_specs_timings_165_fake_41
sum_all_specs_timings_165_fake_41/60
sum_all_specs_timings_165_fake_41/3600

all_specs_timings_165_2_fake_41 <- t_100_r165_r2$ave_timing[5,] * c(nrow(specs_s3_all_u_noinfolags_fake_41), nrow(specs_s4_all_u_noinfolags_fake_41), nrow(specs_s5_all_u_noinfolags_fake_41))/100
sum_all_specs_timings_165_2_fake_41 <- sum(all_specs_timings_165_2_fake_41)
sum_all_specs_timings_165_2_fake_41
sum_all_specs_timings_165_2_fake_41/60
sum_all_specs_timings_165_2_fake_41/3600


```

### Quicker timing with calibrated ratios

```{r quicktimesize3}
tic()
t_100_u_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                       reps = 3, var_sizes = 3)
toc()

tic()
t_100_r165_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                          reps = 3, t_thresholds = 1.65, var_sizes = 3)
toc()


tic()
t_100_r165_r2_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                          reps = 3, t_thresholds = c(1.65, 2), var_sizes = 3) 
toc()


time_size_3 <- function(var_data = var_data, target_level_ts = this_target_ts,
                        reps = 3, t_thresholds = c(1.65, 2),
                        ratios_u_4_5 = c(1.153169, 2.308947),
                        ratios_1r_4_5 = c(1.311826, 1.430633), 
                        ratios_1r_4_5 = c(1.677138, 2.019805) 
                        n_specs = NULL) {
  
  t_100_u_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                       reps = 3, var_sizes = 3)
  t_100_r1_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                       reps = 3, t_thresholds[1] = t_thresholds, var_sizes = 3)
  t_100_r2_s3 <- time_fit_cv(var_data = var_data, target_level_ts = this_target_ts,
                       reps = 3, t_thresholds =  t_thresholds, var_sizes = 3) 
  
  ts3_u <- t_100_u_s3$ave_timing[3,1]
  ts3_r1 <- t_100_r1_s3$ave_timing[3,1]
  ts3_r2 <- t_100_r1_s3$ave_timing[3,1]
  
  ts345_u <- c(ts3_u, ts3_u*ratios_u_4_5[1], ts3_u*ratios_u_4_5[2])
  ts345_r1 <- c(ts3_r1, ts3_r1*ratios_u_4_5[1], ts3_r1*ratios_u_4_5[2])
  ts345_r2 <- c(ts3_r2, ts3_r2*ratios_u_4_5[1], ts3_r2*ratios_u_4_5[2])
  
  if (is.null(n_specs)) {
    n_s3 <- nrow(all_specifications(
    var_size = 3, all_variables = colnames(var_data), 
    lag_choices = c(3,4,5), use_info_lags = FALSE, 
    var_data = var_data, t_thresholds = 0, silent = TRUE))
    
    n_s4 <- nrow(all_specifications(
    var_size = 4, all_variables = colnames(var_data), 
    lag_choices = c(3,4,5), use_info_lags = FALSE, 
    var_data = var_data, t_thresholds = 0, silent = TRUE))
    
    n_s5 <- nrow(all_specifications(
    var_size = 4, all_variables = colnames(var_data), 
    lag_choices = c(3,4,5), use_info_lags = FALSE, 
    var_data = var_data, t_thresholds = 0, silent = TRUE))
  }
  
  time_u <- ts345_u*c(n_s3, n_s4, n_s5)/100
  time_r1 <- ts345_r1*c(n_s3, n_s4, n_s5)/100
  time_r2 <- ts345_r2*c(n_s3, n_s4, n_s5)/100
  
  return(list(total = c(time_u, time_r1, time_r2),
              by_size_by_100 = c(ts345_u, ts345_r1, ts345_r2))
         )
}


```

### Overall number of models

For a given type of specification (lags, number of variables, restriction) does computing time increases linearly with the number of specifications? (or, equivalently given lags and restrictions, with the number of variable combinations). We expect that model fitting will be straightforward to extrapolate, but cross validation may present some variance, depending on the the proportion of specifications that pass all the tests before cross validation. To make things more expedite, we will use unrestricted models

```{r fit_s345_u1652_100}
# unrestricted, all var_sizes
tic()
f100_u_s3 <- fit_tests_models_table(specs_s3_100_u_nil, var_data = var_data)
t100_u_s3 <- toc()
et_f_100_s3 <-  (t100_u_s3$toc - t100_u_s3$tic)

tic()
f100_u_s4 <- fit_tests_models_table(specs_s4_100_u_nil, var_data = var_data)
t100_u_s4 <- toc()
et_f_100_s4 <-  (t100_u_s4$toc - t100_u_s4$tic)

tic()
f100_u_s5 <- fit_tests_models_table(specs_s5_100_u_nil, var_data = var_data)
t100_u_s5 <- toc()
et_f_100_s5 <-  (t100_u_s5$toc - t100_u_s5$tic)



et_f_100_s3 


```


```{r r smallmidbig_unrest_cv}
tic()
# 9 spec for cv
cv_size_3_50_u <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_u$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_u <- toc()

tic()
# 143 spec for cv (15.9 times the 20_u spec), (a single timing yielded 12x)
cv_size_3_100_u <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_u_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_u <- toc()

tic()
# 1260 spec for cv (8.8 times the 20_u spec), (a single timing yielded 12x)
cv_size_3_1000_u <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_u$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_u <- toc()

et_cv_50_s3 <- (tcv50_u$toc - tcv50_u$tic)
et_cv_100_s3 <- (tcv100_u$toc - tcv100_u$tic)
et_cv_1000_s3 <- (tcv1000_u$toc - tcv1000_u$tic) 

et_cv_50_s3
et_cv_100_s3
et_cv_1000_s3

et_cv_100_s3/et_cv_50_s3
et_cv_1000_s3/et_cv_100_s3

```

### Size 3 versus sizes 4 and 5 

```{r compare_sizes_3_and_4_fit}

tic()
f50_u_s4 <- fit_tests_models_table(specs_s4_50_u_nil, var_data = var_data)
t50_u_s4 <- toc()

tic()
f100_u_s4 <- fit_tests_models_table(specs_s4_100_u_nil, var_data = var_data)
t100_u_s4 <- toc()

tic()
f1000_u_s4 <- fit_tests_models_table(specs_s4_1000_u_nil, var_data = var_data)
t1000_u_s4 <- toc()

et_f_50_s4 <-  (t50_u_s4$toc - t50_u_s4$tic)
et_f_100_s4 <-  (t100_u_s4$toc - t100_u_s4$tic)
et_f_1000_s4 <-  (t1000_u_s4$toc - t1000_u_s4$tic)

et_f_50_s4 
et_f_100_s4 
et_f_1000_s4 

et_f_100_s4/et_f_50_s4 
et_f_1000_s4/et_f_100_s4 

et_f_50_s4/et_f_50_s3
et_f_100_s4/et_f_100_s3
et_f_1000_s4/et_f_1000_s3


```

and cv

```{r compare_sizes_3_and_4_cv}
tic()
# 11 spec for cv
cv_size_4_50_u_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_u_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_u_s4 <- toc()

tic()
# 79 spec for cv 
cv_size_4_100_u_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_u_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_u_s4 <- toc()

tic()
# 737 spec for cv (8.8 times the 20_u spec), (a single timing yielded 12x)
cv_size_4_1000_u_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_u_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_u_s4 <- toc()

et_cv_50_s4 <-  (tcv50_u_s4$toc - tcv50_u_s4$tic)
et_cv_100_s4 <-  (tcv100_u_s4$toc - tcv100_u_s4$tic)
et_cv_1000_s4 <-  (tcv1000_u_s4$toc - tcv1000_u_s4$tic)

et_cv_50_s4 
et_cv_100_s4 
et_cv_1000_s4 

et_cv_100_s4/et_cv_50_s4 
et_cv_1000_s4/et_cv_100_s4 

et_cv_50_s4/et_cv_50_s3
et_cv_100_s4/et_cv_100_s3
et_cv_1000_s4/et_cv_1000_s3


```

size 5 now


```{r compare_sizes_3_and_5_fit}

tic()
f50_u_s5 <- fit_tests_models_table(specs_s5_50_u_nil, var_data = var_data)
t50_u_s5 <- toc()

tic()
f100_u_s5 <- fit_tests_models_table(specs_s5_100_u_nil, var_data = var_data)
t100_u_s5 <- toc()

tic()
f1000_u_s5 <- fit_tests_models_table(specs_s5_1000_u_nil, var_data = var_data)
t1000_u_s5 <- toc()

et_f_50_s5 <-  (t50_u_s5$toc - t50_u_s5$tic)
et_f_100_s5 <-  (t100_u_s5$toc - t100_u_s5$tic)
et_f_1000_s5 <-  (t1000_u_s5$toc - t1000_u_s5$tic)

et_f_50_s5 
et_f_100_s5 
et_f_1000_s5 

et_f_100_s5/et_f_50_s5 
et_f_1000_s5/et_f_100_s5 

et_f_50_s5/et_f_50_s3
et_f_100_s5/et_f_100_s3
et_f_1000_s5/et_f_1000_s3

```

and cv

```{r compare_sizes_3_and_5_cv}
 tic()
# 11 spec for cv
cv_size_5_50_u_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_u_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_u_s5 <- toc()

tic()
# 79 spec for cv 
cv_size_5_100_u_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_u_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_u_s5 <- toc()

tic()
# 737 spec for cv (8.8 times the 20_u spec), (a single timing yielded 12x)
cv_size_5_1000_u_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_u_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_u_s5 <- toc()

et_cv_50_s5 <-  (tcv50_u_s5$toc - tcv50_u_s5$tic)
et_cv_100_s5 <-  (tcv100_u_s5$toc - tcv100_u_s5$tic)
et_cv_1000_s5 <-  (tcv1000_u_s5$toc - tcv1000_u_s5$tic)

et_cv_50_s5 
et_cv_100_s5 
et_cv_1000_s5 

et_cv_100_s5/et_cv_50_s5 
et_cv_1000_s5/et_cv_100_s5 

et_cv_50_s5/et_cv_50_s3
et_cv_100_s5/et_cv_100_s3
et_cv_1000_s5/et_cv_1000_s3


```



### Restricted versus unrestricted


Select specifications

```{r s345_specs_r}

specs_s3_50_165_nil <- sample_n(specs_s3_all_165_noinfolags, 50) 
specs_s3_100_165_nil <- sample_n(specs_s3_all_165_noinfolags, 100) 
specs_s3_1000_165_nil <- sample_n(specs_s3_all_165_noinfolags, 1000) 

specs_s4_50_165_nil <- sample_n(specs_s4_all_165_noinfolags, 50) 
specs_s4_100_165_nil <- sample_n(specs_s4_all_165_noinfolags, 100)  
specs_s4_1000_165_nil <- sample_n(specs_s4_all_165_noinfolags, 1000)  

specs_s5_50_165_nil <- sample_n(specs_s5_all_165_noinfolags, 50) 
specs_s5_100_165_nil <- sample_n(specs_s5_all_165_noinfolags, 100)  
specs_s5_1000_165_nil <- sample_n(specs_s5_all_165_noinfolags, 1000)  

specs_s3_50_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 50) 
specs_s3_100_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 100) 
specs_s3_1000_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 1000) 

specs_s4_50_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 50) 
specs_s4_100_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 100)  
specs_s4_1000_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 1000)  

specs_s5_50_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 50) 
specs_s5_100_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 100)  
specs_s5_1000_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 1000)  

```

fit rest vs unrest

```{r restunrestfit}
tic()
f50_165_s3 <- fit_tests_models_table(specs_s3_50_165_nil, var_data = var_data)
t50_165_s3 <- toc()

tic()
f50_165_2_s3 <- fit_tests_models_table(specs_s3_50_165_2_nil, var_data = var_data)
t50_165_2_s3 <- toc()

tic()
f100_165_s3 <- fit_tests_models_table(specs_s3_100_165_nil, var_data = var_data)
t100_165_s3 <- toc()

tic()
f100_165_2_s3 <- fit_tests_models_table(specs_s3_100_165_2_nil, var_data = var_data)
t100_165_2_s3 <- toc()

tic()
f1000_165_s3 <- fit_tests_models_table(specs_s3_1000_165_nil, var_data = var_data)
t1000_165_s3 <- toc()

tic()
f1000_165_2_s3 <- fit_tests_models_table(specs_s3_1000_165_2_nil, var_data = var_data)
t1000_165_2_s3 <- toc()



tic()
f50_165_s4 <- fit_tests_models_table(specs_s4_50_165_nil, var_data = var_data)
t50_165_s4 <- toc()

tic()
f50_165_2_s4 <- fit_tests_models_table(specs_s4_50_165_2_nil, var_data = var_data)
t50_165_2_s4 <- toc()

tic()
f100_165_s4 <- fit_tests_models_table(specs_s4_100_165_nil, var_data = var_data)
t100_165_s4 <- toc()

tic()
f100_165_2_s4 <- fit_tests_models_table(specs_s4_100_165_2_nil, var_data = var_data)
t100_165_2_s4 <- toc()

tic()
f1000_165_s4 <- fit_tests_models_table(specs_s4_1000_165_nil, var_data = var_data)
t1000_165_s4 <- toc()

tic()
f1000_165_2_s4 <- fit_tests_models_table(specs_s4_1000_165_2_nil, var_data = var_data)
t1000_165_2_s4 <- toc()





tic()
f50_165_s5 <- fit_tests_models_table(specs_s5_50_165_nil, var_data = var_data)
t50_165_s5 <- toc()

tic()
f50_165_2_s5 <- fit_tests_models_table(specs_s5_50_165_2_nil, var_data = var_data)
t50_165_2_s5 <- toc()

tic()
f100_165_s5 <- fit_tests_models_table(specs_s5_100_165_nil, var_data = var_data)
t100_165_s5 <- toc()

tic()
f100_165_2_s5 <- fit_tests_models_table(specs_s5_100_165_2_nil, var_data = var_data)
t100_165_2_s5 <- toc()

tic()
f1000_165_s5 <- fit_tests_models_table(specs_s5_1000_165_nil, var_data = var_data)
t1000_165_s5 <- toc()

tic()
f1000_165_2_s5 <- fit_tests_models_table(specs_s5_1000_165_2_nil, var_data = var_data)
t1000_165_2_s5 <- toc()



et_f_50_s3_165 <-  (t50_165_s3$toc - t50_165_s3$tic)
et_f_50_s3_165_2 <-  (t50_165_2_s3$toc - t50_165_2_s3$tic)
et_f_100_s3_165 <-  (t100_165_s3$toc - t100_165_s3$tic)
et_f_100_s3_165_2 <-  (t100_165_2_s3$toc - t100_165_2_s3$tic)
et_f_1000_s3_165 <-  (t100_165_s3$toc - t1000_165_s3$tic)
et_f_1000_s3_165_2 <-  (t100_165_2_s3$toc - t1000_165_2_s3$tic)

et_f_50_s4_165 <-  (t50_165_s4$toc - t50_165_s4$tic)
et_f_50_s4_165_2 <-  (t50_165_2_s4$toc - t50_165_2_s4$tic)
et_f_100_s4_165 <-  (t100_165_s4$toc - t100_165_s4$tic)
et_f_100_s4_165_2 <-  (t100_165_2_s4$toc - t100_165_2_s4$tic)
et_f_1000_s4_165 <-  (t1000_165_s4$toc - t1000_165_s4$tic)
et_f_1000_s4_165_2 <-  (t1000_165_2_s4$toc - t1000_165_2_s4$tic)

et_f_50_s5_165 <-  (t50_165_s5$toc - t50_165_s5$tic)
et_f_50_s5_165_2 <-  (t50_165_2_s5$toc - t50_165_2_s5$tic)
et_f_100_s5_165 <-  (t100_165_s5$toc - t100_165_s5$tic)
et_f_100_s5_165_2 <-  (t100_165_2_s5$toc - t100_165_2_s5$tic)
et_f_1000_s5_165 <-  (t1000_165_s5$toc - t1000_165_s5$tic)
et_f_1000_s5_165_2 <-  (t1000_165_2_s5$toc - t1000_165_2_s5$tic)



u_et_f_50_s3_165 <- et_f_50_s3_165 / et_f_50_s3  
u_et_f_50_s3_165_2 <- et_f_50_s3_165_2 / et_f_50_s3  
u_et_f_100_s3_165 <- et_f_100_s3_165 / et_f_100_s3  
u_et_f_100_s3_165_2 <- et_f_100_s3_165_2 / et_f_100_s3 
u_et_f_1000_s3_165 <- et_f_1000_s3_165 / et_f_1000_s3  
u_et_f_1000_s3_165_2 <- et_f_1000_s3_165_2 / et_f_1000_s3 

u_et_f_50_s4_165 <- et_f_50_s4_165 / et_f_50_s4  
u_et_f_50_s4_165_2 <- et_f_50_s4_165_2 / et_f_50_s4  
u_et_f_100_s4_165 <- et_f_100_s4_165 / et_f_100_s4  
u_et_f_100_s4_165_2 <- et_f_100_s4_165_2 / et_f_100_s4 
u_et_f_1000_s4_165 <- et_f_1000_s4_165 / et_f_1000_s4  
u_et_f_1000_s4_165_2 <- et_f_1000_s4_165_2 / et_f_1000_s4 

u_et_f_50_s5_165 <- et_f_50_s5_165 / et_f_50_s5  
u_et_f_50_s5_165_2 <- et_f_50_s5_165_2 / et_f_50_s5  
u_et_f_100_s5_165 <- et_f_100_s5_165 / et_f_100_s5  
u_et_f_100_s5_165_2 <- et_f_100_s5_165_2 / et_f_100_s5 
u_et_f_1000_s5_165 <- et_f_1000_s5_165 / et_f_1000_s5  
u_et_f_1000_s5_165_2 <- et_f_1000_s5_165_2 / et_f_1000_s5 


u_et_f_50_s3_165 
u_et_f_50_s3_165_2 
u_et_f_1000_s3_165  
u_et_f_1000_s3_165_2

u_et_f_50_s4_165 
u_et_f_50_s4_165_2   
u_et_f_1000_s4_165 
u_et_f_1000_s4_165_2  

u_et_f_50_s5_165  
u_et_f_50_s5_165_2 
u_et_f_100_s5_165  
u_et_f_100_s5_165_2 
u_et_f_1000_s5_165  
u_et_f_1000_s5_165_2 





```

cv rest vs unrest

```{r restunrestcv}

tic()
# 11 spec for cv
cv_size_3_50_165_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_s3 <- toc()

tic()
# 79 spec for cv 
cv_size_3_50_165_2_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_2_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_2_s3 <- toc()

tic()
# 11 spec for cv
cv_size_3_100_165_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_s3 <- toc()

tic()
# 79 spec for cv 
cv_size_3_100_165_2_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_2_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_2_s3 <- toc()


tic()
# 11 spec for cv
cv_size_3_1000_165_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_165_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_165_s3 <- toc()

tic()
# 79 spec for cv 
cv_size_3_1000_165_2_s3 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_165_2_s3$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_165_2_s3 <- toc()







tic()
# 11 spec for cv
cv_size_4_50_165_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_s4 <- toc()

tic()
# 79 spec for cv 
cv_size_4_50_165_2_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_2_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_2_s4 <- toc()

tic()
# 11 spec for cv
cv_size_4_100_165_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_s4 <- toc()

tic()
# 79 spec for cv 
cv_size_4_100_165_2_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_2_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_2_s4 <- toc()

tic()
# 11 spec for cv
cv_size_4_1000_165_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_165_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_165_s4 <- toc() 

tic()
# 79 spec for cv 
cv_size_4_1000_165_2_s4 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f1000_165_2_s4$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_165_2_s4 <- toc()




tic()
# 11 spec for cv
cv_size_5_50_165_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_s5 <- toc()

tic()
# 79 spec for cv 
cv_size_5_50_165_2_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f50_165_2_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv50_165_2_s5 <- toc()

tic()
# 11 spec for cv
cv_size_5_100_165_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_s5 <- toc()

tic()
# 79 spec for cv 
cv_size_5_100_165_2_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_2_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_2_s5 <- toc()


tic()
# 11 spec for cv
cv_size_5_1000_165_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv100_165_s5 <- toc()

tic()
# 79 spec for cv 
cv_size_5_1000_165_2_s5 <- cv_var_from_model_tbl(h = fc_horizon,
                             training_length = training_length, 
                             n_cv = n_cv,
                             models_tbl = f100_165_2_s5$passing_models, 
                             var_data = var_data, 
                             fit_column = "fit", 
                             target_transform = target_transform,
                             target_level_ts = target_level_ts,
                             )
tcv1000_165_2_s5 <- toc()



et_cv_50_s3_165 <-  (tcv50_165_s3$toc - tcv50_165_s3$tic)
et_cv_50_s3_165_2 <-  (tcv50_165_2_s3$toc - tcv50_165_2_s3$tic)
et_cv_100_s3_165 <-  (tcv100_165_s3$toc - tcv100_165_s3$tic)
et_cv_100_s3_165_2 <-  (tcv100_165_2_s3$toc - tcv100_165_2_s3$tic)

et_cv_50_s4_165 <-  (tcv50_165_s4$toc - tcv50_165_s4$tic)
et_cv_50_s4_165_2 <-  (tcv50_165_2_s4$toc - tcv50_165_2_s4$tic)
et_cv_100_s4_165 <-  (tcv100_165_s4$toc - tcv100_165_s4$tic)
et_cv_100_s4_165_2 <-  (tcv100_165_2_s4$toc - tcv100_165_2_s4$tic)

et_cv_50_s5_165 <-  (tcv50_165_s5$toc - tcv50_165_s5$tic)
et_cv_50_s5_165_2 <-  (tcv50_165_2_s5$toc - tcv50_165_2_s5$tic)
et_cv_100_s5_165 <-  (tcv100_165_s5$toc - tcv100_165_s5$tic)
et_cv_100_s5_165_2 <-  (tcv100_165_2_s5$toc - tcv100_165_2_s5$tic)



u_et_cv_50_s3_165 <- et_cv_50_s3_165 / et_cv_50_s3  
u_et_cv_50_s3_165_2 <- et_cv_50_s3_165_2 / et_cv_50_s3  
u_et_cv_100_s3_165 <- et_cv_100_s3_165 / et_cv_100_s3  
u_et_cv_100_s3_165_2 <- et_cv_100_s3_165_2 / et_cv_100_s3 

u_et_cv_50_s4_165 <- et_cv_50_s4_165 / et_cv_50_s4  
u_et_cv_50_s4_165_2 <- et_cv_50_s4_165_2 / et_cv_50_s4  
u_et_cv_100_s4_165 <- et_cv_100_s4_165 / et_cv_100_s4  
u_et_cv_100_s4_165_2 <- et_cv_100_s4_165_2 / et_cv_100_s4 

u_et_cv_50_s5_165 <- et_cv_50_s5_165 / et_cv_50_s5  
u_et_cv_50_s5_165_2 <- et_cv_50_s5_165_2 / et_cv_50_s5  
u_et_cv_100_s5_165 <- et_cv_100_s5_165 / et_cv_100_s5  
u_et_cv_100_s5_165_2 <- et_cv_100_s5_165_2 / et_cv_100_s5 





u_et_cv_50_s3_165
u_et_cv_50_s3_165_2  
u_et_cv_100_s3_165  
u_et_cv_100_s3_165_2 

u_et_cv_50_s4_165  
u_et_cv_50_s4_165_2  
u_et_cv_100_s4_165  
u_et_cv_100_s4_165_2 

u_et_cv_50_s5_165  
u_et_cv_50_s5_165_2  
u_et_cv_100_s5_165 
u_et_cv_100_s5_165_2 






```


### Table with timings

```{r timingsastable_given_n_100}

tnames <- c("size_3", "size_4 factor", "size_5 factor")

 
et_f_100_s3 
et_f_1000_s3 

s3_timings_f <- c(et_f_100_s3, et_f_100_s3_165, et_f_100_s3_165_2)
s4_timings_f <- c(et_f_100_s4, et_f_100_s4_165, et_f_100_s4_165_2)
s5_timings_f <- c(et_f_100_s5, et_f_100_s5_165, et_f_100_s5_165_2)

s3_timings_cv <- c(et_cv_100_s3)

# et_f_100_s4

```

scaling n

```{r timingsastable_changing_n_given_size}

```




<!-- ```{r ftmt_size_3_smb} -->

<!-- tic() -->
<!-- ftmt_size_3_small <- fit_tests_models_table(specifications_size_3_small, var_data = var_data) -->
<!-- toc() -->
<!-- pm_size_3_small <- ftmt_size_3_small[["passing_models"]] -->

<!-- ftmt_size_3_small_no_fit <- fit_tests_models_table(specifications_size_3_small, var_data = var_data, -->
<!--                                 keep_fit = FALSE) -->
<!-- pm_size_3_small_no_fit <- ftmt_size_3_small_no_fit[["passing_models"]] -->


<!-- tic() -->
<!-- ftmt_size_3_medium <- fit_tests_models_table(specifications_size_3_medium, var_data = var_data) -->
<!-- toc() -->
<!-- pm_size_3_medium <- ftmt_size_3_medium[["passing_models"]] -->


<!-- # ftmt_size_3_medium_no_fit <- fit_tests_models_table(specifications_size_3_medium, var_data = var_data,   keep_fit = FALSE) -->
<!-- # pm_size_3_medium_no_fit <- ftmt_size_3_medium_no_fit[["passing_models"]] -->

<!-- # tic() -->
<!-- # ftmt_size_3_big_no_fit <- fit_tests_models_table(specifications_size_3_big, var_data = var_data,   keep_fit = FALSE) -->
<!-- # toc() -->
<!-- # pm_size_3_big_no_fit <- ftmt_size_3_big_no_fit[["passing_models"]] -->


<!-- ``` -->




<!-- ```{r ftmt_size_4_smb} -->

<!-- tic() -->
<!-- ftmt_size_4_small <- fit_tests_models_table(specifications_size_4_small, var_data = var_data) -->
<!-- toc() -->
<!-- pm_size_4_small <- ftmt_size_4_small[["passing_models"]] -->

<!-- ftmt_size_4_small_no_fit <- fit_tests_models_table(specifications_size_4_small, var_data = var_data, -->
<!--                                 keep_fit = FALSE) -->
<!-- pm_size_4_small_no_fit <- ftmt_size_4_small_no_fit[["passing_models"]] -->


<!-- tic() -->
<!-- ftmt_size_4_medium <- fit_tests_models_table(specifications_size_4_medium, var_data = var_data) -->
<!-- toc() -->
<!-- pm_size_4_medium <- ftmt_size_4_medium[["passing_models"]] -->


<!-- # ftmt_size_4_medium_no_fit <- fit_tests_models_table(specifications_size_4_medium, var_data = var_data,   keep_fit = FALSE) -->
<!-- # pm_size_4_medium_no_fit <- ftmt_size_4_medium_no_fit[["passing_models"]] -->

<!-- # tic() -->
<!-- # ftmt_size_4_big_no_fit <- fit_tests_models_table(specifications_size_4_big, var_data = var_data,   keep_fit = FALSE) -->
<!-- # toc() -->
<!-- # pm_size_4_big_no_fit <- ftmt_size_4_big_no_fit[["passing_models"]] -->


<!-- ``` -->




### Into the thousands

```{r otherspecs}
specs_s3_50_u_nil <- sample_n(specifications_size_3_all_u_noinfolags, 50) 
specs_s3_1000_u_nil <- sample_n(specifications_size_3_all_u_noinfolags, 1000) 

specs_s4_50_u_nil <- sample_n(specifications_size_4_all_u_noinfolags, 50) 
specs_s4_1000_u_nil <- sample_n(specifications_size_4_all_u_noinfolags, 1000) 

specs_s5_50_u_nil <- sample_n(specifications_size_5_all_u_noinfolags, 50) 
specs_s5_1000_u_nil <- sample_n(specifications_size_5_all_u_noinfolags, 1000) 


specs_s3_50_165_nil <- sample_n(specs_s3_all_165_noinfolags, 50) 
specs_s3_1000_165_nil <- sample_n(specs_s3_all_165_noinfolags, 1000) 

specs_s4_50_165_nil <- sample_n(specs_s4_all_165_noinfolags, 50) 
specs_s4_1000_165_nil <- sample_n(specs_s4_all_165_noinfolags, 1000)  

specs_s5_50_165_nil <- sample_n(specs_s5_all_165_noinfolags, 50) 
specs_s5_1000_165_nil <- sample_n(specs_s5_all_165_noinfolags, 1000)  

specs_s3_50_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 50) 
specs_s3_1000_165_2_nil <- sample_n(specs_s3_all_165_2_noinfolags, 1000) 

specs_s4_50_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 50) 
specs_s4_1000_165_2_nil <- sample_n(specs_s4_all_165_2_noinfolags, 1000)  

specs_s5_50_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 50) 
specs_s5_1000_165_2_nil <- sample_n(specs_s5_all_165_2_noinfolags, 1000)  



```



```{r s3s4s5_1000f}
tic()
f50_u <- fit_tests_models_table(specs_s3_50_u_nil, var_data = var_data)
t50_u <- toc()

tic()
f1000_u <- fit_tests_models_table(specs_s3_1000_u_nil, var_data = var_data)
t1000_u <- toc()
```

